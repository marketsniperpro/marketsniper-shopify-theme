{% comment %}
  sections/main-cart.liquid
  Shopping cart page - TradingView username only, Discord auto-linked via email
{% endcomment %}

<section class="cart-page">
  <div class="container">
    <h1 class="cart-title">{{ section.settings.cart_title | default: "Your Cart" }}</h1>

    {% if cart.item_count > 0 %}
      <div class="cart-content">
        <!-- Left Column: Cart Items -->
        <div class="cart-left-column">
          <div class="cart-items">
            {% for item in cart.items %}
              {% assign is_setup = false %}
              {% if item.product.title contains 'Setup' or item.product.title contains 'Professional' %}
                {% assign is_setup = true %}
              {% endif %}
              
              <div class="cart-item {% if is_setup %}setup-item{% endif %}" data-line="{{ forloop.index }}">
                <div class="item-image">
                  {% if item.image %}
                    <img src="{{ item.image | img_url: 'medium' }}" alt="{{ item.title | escape }}">
                  {% elsif is_setup %}
                    <img src="{{ 'bot-suite-setup.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                  {% elsif item.product.handle contains 'annual' or item.product.handle contains '490' %}
                    <img src="{{ 'bot-suite-annual.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                  {% elsif item.product.handle contains 'monthly' or item.product.handle contains '49' %}
                    <img src="{{ 'bot-suite-monthly.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                  {% else %}
                    <img src="{{ 'trading-bot-suite.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                  {% endif %}
                </div>

                <div class="item-details">
                  {% if is_setup %}
                    <span class="optional-badge">Optional<br>Add-On</span>
                  {% endif %}
                  
                  <h3 class="item-title">{{ item.product.title }}</h3>
                  {% if item.variant.title != 'Default Title' %}
                    <p class="item-variant">{{ item.variant.title }}</p>
                  {% endif %}
                  
                  {% if item.selling_plan_allocation %}
                    <div class="subscription-info">
                      <span class="subscription-badge">Subscription</span>
                      <p class="subscription-name">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                    </div>
                  {% else %}
                    <p class="item-variant">one-time</p>
                  {% endif %}

                  <p class="item-price">{{ item.final_line_price | money }}</p>
                </div>

                <!-- Remove button positioned absolutely -->
                <button class="remove-btn" data-line="{{ forloop.index }}" aria-label="Remove item">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- Right Column: TradingView Username + Order Summary -->
        <div class="cart-right-column">
          <!-- TradingView Username Field -->
          <div class="tradingview-field-container">
            <h3 class="tradingview-title">TradingView Account Required</h3>
            <p class="tradingview-description">Enter your TradingView username for indicator access</p>
            
            <input 
              type="text" 
              id="tradingview-username" 
              name="attributes[TradingView Username]" 
              placeholder="e.g., JohnTrader123"
              value="{{ cart.attributes['TradingView Username'] }}"
              class="tradingview-input"
              required
            >
            
            <p class="tradingview-note">* Must match exactly (case-sensitive)</p>
          </div>

          <!-- Order Summary with Checkboxes -->
          <div class="cart-summary">
            <h2>Order Summary</h2>
            
            <div class="summary-line">
              <span>Subtotal:</span>
              <span class="subtotal">{{ cart.total_price | money }}</span>
            </div>

            {% if cart.cart_level_discount_applications.size > 0 %}
              {% for discount in cart.cart_level_discount_applications %}
                <div class="summary-line discount">
                  <span>Discount ({{ discount.title }}):</span>
                  <span>-{{ discount.total_allocated_amount | money }}</span>
                </div>
              {% endfor %}
            {% endif %}

            <div class="summary-divider"></div>

            <div class="summary-line total">
              <span>Total:</span>
              <span class="total-price">{{ cart.total_price | money }}</span>
            </div>

            <p class="tax-note">Taxes and shipping calculated at checkout</p>

            <!-- Required Acknowledgments Inside Summary -->
            <div class="required-acknowledgments">
              <label class="acknowledgment-item">
                <input type="checkbox" id="acknowledge-1" class="acknowledgment-checkbox">
                <span>Full automation may require TradingView Premium, third-party automation services, and real-time data subscriptions (additional costs apply).</span>
              </label>

              <label class="acknowledgment-item">
                <input type="checkbox" id="acknowledge-2" class="acknowledgment-checkbox">
                <span>Past performance does not indicate future returns. Trading involves substantial risk of loss.</span>
              </label>

              <label class="acknowledgment-item">
                <input type="checkbox" id="acknowledge-3" class="acknowledgment-checkbox">
                <span>I will check my order confirmation email for Discord invites and setup instructions, regardless of whether I'm currently in the Discord server.</span>
              </label>
            </div>

            <button type="button" class="checkout-btn" id="checkout-button" onclick="validateAndCheckout()">
              PROCEED TO CHECKOUT
            </button>

            <a href="/" class="continue-shopping">
              ‚Üê Continue Shopping
            </a>
          </div>
        </div>
      </div>
    {% else %}
      <div class="empty-cart">
        <p class="empty-message">Your cart is empty</p>
        <a href="/#pricing" class="return-btn">View Pricing Plans</a>
      </div>
    {% endif %}
  </div>
</section>

<!-- Toast Notification -->
<div id="cart-toast" class="cart-toast"></div>

<style>
  /* Two column layout for main content */
  .cart-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 24px;
  }

  .cart-left-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .cart-right-column {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Consistent 1px borders for all boxes */
  .cart-item {
    border: 1px solid rgba(0, 255, 136, 0.3) !important;
  }

  .tradingview-field-container {
    background: rgba(0, 20, 10, 0.3) !important;
    border: 1px solid rgba(0, 255, 136, 0.3) !important;
  }

  .cart-summary {
    border: 1px solid rgba(0, 255, 136, 0.3) !important;
    background: rgba(0, 20, 10, 0.2);
  }

  .cart-summary h2 {
    color: #00ff88;
    font-size: 22px;
    margin-bottom: 20px;
  }

  .summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    color: #b8b8b8;
    font-size: 15px;
  }

  .summary-line.total {
    margin-top: 16px;
    margin-bottom: 8px;
  }

  .summary-line.total span {
    font-size: 20px;
    font-weight: 700;
    color: #e8e8e8;
  }

  .summary-line.total .total-price {
    color: #00ff88;
  }

  .summary-divider {
    height: 1px;
    background: rgba(0, 255, 136, 0.2);
    margin: 16px 0;
  }

  .tax-note {
    color: #7a7a7a;
    font-size: 12px;
    margin-bottom: 20px;
  }

  .required-acknowledgments {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(0, 255, 136, 0.2) !important;
    border-radius: 8px;
    padding: 16px;
    margin: 20px 0;
  }

  .acknowledgment-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 14px;
    cursor: pointer;
    color: #b8b8b8;
    font-size: 13px;
    line-height: 1.5;
  }

  .acknowledgment-item:last-child {
    margin-bottom: 0;
  }

  .acknowledgment-checkbox {
    width: 18px;
    height: 18px;
    margin-top: 2px;
    cursor: pointer;
    flex-shrink: 0;
    accent-color: #00ff88;
  }

  .acknowledgment-item:hover {
    color: #e8e8e8;
  }

  .checkout-btn {
    width: 100%;
    background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
    color: #000;
    font-weight: 700;
    font-size: 15px;
    letter-spacing: 0.5px;
    padding: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
  }

  .checkout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
  }

  .checkout-btn:active {
    transform: translateY(0);
  }

  .continue-shopping {
    display: block;
    text-align: center;
    color: #00ff88;
    font-size: 14px;
    margin-top: 16px;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .continue-shopping:hover {
    color: #00cc66;
  }

  /* Mobile responsive */
  @media (max-width: 968px) {
    .cart-content {
      grid-template-columns: 1fr;
      gap: 20px;
    }
  }

  @media (max-width: 768px) {
    .cart-summary h2 {
      font-size: 20px;
    }

    .summary-line {
      font-size: 14px;
    }

    .summary-line.total span {
      font-size: 18px;
    }

    .required-acknowledgments {
      padding: 14px;
    }

    .acknowledgment-item {
      font-size: 12px;
      gap: 10px;
      margin-bottom: 12px;
    }

    .acknowledgment-checkbox {
      width: 17px;
      height: 17px;
    }

    .checkout-btn {
      font-size: 14px;
      padding: 14px;
    }
  }
</style>

<script>
  function validateAndCheckout() {
    const checkbox1 = document.getElementById('acknowledge-1');
    const checkbox2 = document.getElementById('acknowledge-2');
    const checkbox3 = document.getElementById('acknowledge-3');
    
    if (!checkbox1.checked || !checkbox2.checked || !checkbox3.checked) {
      showToast('Please acknowledge all required items before checkout', 'error');
      return false;
    }
    
    // Validate TradingView username
    const tvUsername = document.getElementById('tradingview-username').value.trim();
    if (!tvUsername) {
      showToast('Please enter your TradingView username', 'error');
      return false;
    }
    
    // Proceed to checkout
    window.location.href = '/checkout';
  }

  function showToast(message, type = 'info') {
    const toast = document.getElementById('cart-toast');
    toast.textContent = message;
    toast.className = 'cart-toast show ' + type;
    setTimeout(() => {
      toast.classList.remove('show');
    }, 3000);
  }
</script>

<script src="{{ 'cart.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Cart",
  "settings": [
    {
      "type": "text",
      "id": "cart_title",
      "label": "Cart Title",
      "default": "Your Cart"
    },
    {
      "type": "text",
      "id": "empty_cart_message",
      "label": "Empty Cart Message",
      "default": "Your cart is currently empty."
    },
    {
      "type": "text",
      "id": "continue_shopping_text",
      "label": "Continue Shopping Button Text",
      "default": "Continue Shopping"
    }
  ]
}
{% endschema %}