{% comment %}
  sections/main-cart.liquid
  Shopping cart page - TradingView username only, Discord auto-linked via email
{% endcomment %}

<section class="cart-page">
  <div class="container">
    <h1 class="cart-title">{{ section.settings.cart_title | default: "Your Cart" }}</h1>

    {% if cart.item_count > 0 %}
      <div class="cart-content">
        <!-- Cart Items -->
        <div class="cart-items">
          {% for item in cart.items %}
            {% assign is_setup = false %}
            {% if item.product.title contains 'Setup' or item.product.title contains 'Professional' %}
              {% assign is_setup = true %}
            {% endif %}
            
            <div class="cart-item {% if is_setup %}setup-item{% endif %}" data-line="{{ forloop.index }}">
              <div class="item-image">
                {% if item.image %}
                  <img src="{{ item.image | img_url: 'medium' }}" alt="{{ item.title | escape }}">
                {% elsif is_setup %}
                  <img src="{{ 'bot-suite-setup.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% elsif item.product.handle contains 'annual' or item.product.handle contains '490' %}
                  <img src="{{ 'bot-suite-annual.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% elsif item.product.handle contains 'monthly' or item.product.handle contains '49' %}
                  <img src="{{ 'bot-suite-monthly.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% else %}
                  <img src="{{ 'trading-bot-suite.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% endif %}
              </div>

              <div class="item-details">
                {% if is_setup %}
                  <span class="optional-badge">Optional<br>Add-On</span>
                {% endif %}
                
                <h3 class="item-title">{{ item.product.title }}</h3>
                {% if item.variant.title != 'Default Title' %}
                  <p class="item-variant">{{ item.variant.title }}</p>
                {% endif %}
                
                {% if item.selling_plan_allocation %}
                  <div class="subscription-info">
                    <span class="subscription-badge">Subscription</span>
                    <p class="subscription-name">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                  </div>
                {% else %}
                  <p class="item-variant">one-time</p>
                {% endif %}

                <p class="item-price">{{ item.final_line_price | money }}</p>
              </div>

              <!-- Remove button positioned absolutely -->
              <button class="remove-btn" data-line="{{ forloop.index }}" aria-label="Remove item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>
          {% endfor %}
        </div>

        <!-- TradingView Username Field -->
        <div class="tradingview-field-container">
          <h3 class="tradingview-title">TradingView Account Required</h3>
          <p class="tradingview-description">Enter your TradingView username for indicator access</p>
          
          <input 
            type="text" 
            id="tradingview-username" 
            name="attributes[TradingView Username]" 
            placeholder="e.g., JohnTrader123"
            value="{{ cart.attributes['TradingView Username'] }}"
            class="tradingview-input"
            required
          >
          
          <p class="tradingview-note">* Must match exactly (case-sensitive)</p>
          
          <div style="background: rgba(0, 20, 10, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; padding: 16px; margin-top: 20px;">
            <div style="margin-bottom: 10px;">
              <strong style="color: #00ff00; font-size: 15px; font-weight: 700;">Discord Access:</strong>
            </div>
            <p style="color: #b8b8b8; font-size: 14px; line-height: 1.6; margin: 0;">
              Your Discord will be automatically linked using your email. If you're not in our Discord yet, you'll receive an invitation link after purchase!
            </p>
          </div>
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary">
          <h2>Order Summary</h2>
          
          <div class="summary-line">
            <span>Subtotal:</span>
            <span class="subtotal">{{ cart.total_price | money }}</span>
          </div>

          {% if cart.cart_level_discount_applications.size > 0 %}
            {% for discount in cart.cart_level_discount_applications %}
              <div class="summary-line discount">
                <span>Discount ({{ discount.title }}):</span>
                <span>-{{ discount.total_allocated_amount | money }}</span>
              </div>
            {% endfor %}
          {% endif %}

          <div class="summary-line total">
            <span>Total:</span>
            <span class="total-price">{{ cart.total_price | money }}</span>
          </div>

          <p class="tax-note">Taxes and shipping calculated at checkout</p>

          <button type="button" class="checkout-btn" onclick="validateAndCheckout()">
            Proceed to Checkout
          </button>

          <a href="/" class="continue-shopping">
            ‚Üê Continue Shopping
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty-cart">
        <p class="empty-message">Your cart is empty</p>
        <a href="/#pricing" class="return-btn">View Pricing Plans</a>
      </div>
    {% endif %}
  </div>
</section>

<!-- Toast Notification -->
<div id="cart-toast" class="cart-toast"></div>

<script src="{{ 'cart.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Cart",
  "settings": [
    {
      "type": "text",
      "id": "cart_title",
      "label": "Cart Title",
      "default": "Your Cart"
    },
    {
      "type": "text",
      "id": "empty_cart_message",
      "label": "Empty Cart Message",
      "default": "Your cart is currently empty."
    },
    {
      "type": "text",
      "id": "continue_shopping_text",
      "label": "Continue Shopping Button Text",
      "default": "Continue Shopping"
    }
  ]
}
{% endschema %}
