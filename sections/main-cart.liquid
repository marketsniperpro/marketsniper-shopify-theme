{% comment %}
  sections/main-cart.liquid
  Shopping cart page - TradingView username only, Discord auto-linked via email
{% endcomment %}

<section class="cart-page">
  <div class="container">
    <h1 class="cart-title">{{ section.settings.cart_title | default: "Your Cart" }}</h1>

    {% if cart.item_count > 0 %}
      <div class="cart-content">
        <!-- Cart Items -->
        <div class="cart-items">
          {% for item in cart.items %}
            {% assign is_setup = false %}
            {% if item.product.title contains 'Setup' or item.product.title contains 'Professional' %}
              {% assign is_setup = true %}
            {% endif %}
            
            <div class="cart-item {% if is_setup %}setup-item{% endif %}" data-line="{{ forloop.index }}">
              <div class="item-image">
                {% if item.image %}
                  <img src="{{ item.image | img_url: 'medium' }}" alt="{{ item.title | escape }}">
                {% elsif is_setup %}
                  <img src="{{ 'bot-suite-setup.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% elsif item.product.handle contains 'annual' or item.product.handle contains '490' %}
                  <img src="{{ 'bot-suite-annual.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% elsif item.product.handle contains 'monthly' or item.product.handle contains '49' %}
                  <img src="{{ 'bot-suite-monthly.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% else %}
                  <img src="{{ 'trading-bot-suite.jpg' | asset_url }}" alt="{{ item.title | escape }}">
                {% endif %}
              </div>

              <div class="item-details">
                {% if is_setup %}
                  <span class="optional-badge">Optional<br>Add-On</span>
                {% endif %}
                
                <h3 class="item-title">{{ item.product.title }}</h3>
                {% if item.variant.title != 'Default Title' %}
                  <p class="item-variant">{{ item.variant.title }}</p>
                {% endif %}
                
                {% if item.selling_plan_allocation %}
                  <div class="subscription-info">
                    <span class="subscription-badge">Subscription</span>
                    <p class="subscription-name">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                  </div>
                {% else %}
                  <p class="item-variant">one-time</p>
                {% endif %}

                <p class="item-price">{{ item.final_line_price | money }}</p>
              </div>

              <!-- Remove button positioned absolutely -->
              <button class="remove-btn" data-line="{{ forloop.index }}" aria-label="Remove item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
              </button>
            </div>
          {% endfor %}
        </div>

        <!-- TradingView Username Field -->
        <div class="tradingview-field-container">
          <h3 class="tradingview-title">TradingView Account Required</h3>
          <p class="tradingview-description">Enter your TradingView username for indicator access</p>
          
          <input 
            type="text" 
            id="tradingview-username" 
            name="attributes[TradingView Username]" 
            placeholder="e.g., JohnTrader123"
            value="{{ cart.attributes['TradingView Username'] }}"
            class="tradingview-input"
            required
          >
          
          <p class="tradingview-note">* Must match exactly (case-sensitive)</p>
          
          <div style="background: rgba(0, 20, 10, 0.3); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 8px; padding: 16px; margin-top: 20px;">
            <div style="margin-bottom: 10px;">
              <strong style="color: #00ff00; font-size: 15px; font-weight: 700;">Discord Access:</strong>
            </div>
            <p style="color: #b8b8b8; font-size: 14px; line-height: 1.6; margin: 0;">
              Your Discord will be automatically linked using your email. If you're not in our Discord yet, you'll receive an invitation link after purchase!
            </p>
          </div>
        </div>

        <!-- Required Prerequisites Section -->
        <div class="prerequisites-container">
          <h3 class="prerequisites-title">REQUIRED PREREQUISITES</h3>
          
          <div class="prerequisite-item">
            <div class="prerequisite-number">1</div>
            <div class="prerequisite-content">
              <strong>TradingView Premium Account Required</strong>
              <p>A paid TradingView subscription (Pro, Pro+, or Premium) is required for full automation and real-time alerts. Basic/Free accounts have limited functionality.</p>
            </div>
          </div>

          <div class="prerequisite-item">
            <div class="prerequisite-number">2</div>
            <div class="prerequisite-content">
              <strong>Third-Party Broker/Exchange Integration</strong>
              <p>Full automation requires a compatible third-party automation service (e.g., 3Commas, Alertatron, or similar) to execute trades. Additional subscription costs may apply.</p>
            </div>
          </div>

          <div class="prerequisite-item">
            <div class="prerequisite-number">3</div>
            <div class="prerequisite-content">
              <strong>Exchange/Broker Data Subscriptions</strong>
              <p>Real-time data subscriptions from your exchange or broker may be required for optimal performance. Costs vary by provider.</p>
            </div>
          </div>

          <div class="prerequisite-item disclaimer">
            <div class="prerequisite-label">RISK DISCLOSURE</div>
            <div class="prerequisite-content">
              <strong>Trading Risk Warning</strong>
              <p><strong>Past performance does not indicate future returns.</strong> Trading involves substantial risk of loss. Only trade with capital you can afford to lose.</p>
            </div>
          </div>

          <div class="prerequisite-item action-required">
            <div class="prerequisite-label">ACTION REQUIRED</div>
            <div class="prerequisite-content">
              <strong>Important: Check Your Email After Purchase</strong>
              <p><strong>You MUST open your Shopify order confirmation email</strong> to:</p>
              <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #b8b8b8;">
                <li>Receive your Discord server invite link (if not already a member)</li>
                <li>Get automatic Discord role assignment</li>
                <li>Access setup call scheduling link (if you purchased the setup service)</li>
                <li>View complete onboarding instructions</li>
              </ul>
              <p style="margin-top: 8px; color: #ff6b6b; font-weight: 600;">Without opening this email, you will not receive access to Discord roles or onboarding resources.</p>
            </div>
          </div>
        </div>

        <!-- Cart Summary -->
        <div class="cart-summary">
          <h2>Order Summary</h2>
          
          <div class="summary-line">
            <span>Subtotal:</span>
            <span class="subtotal">{{ cart.total_price | money }}</span>
          </div>

          {% if cart.cart_level_discount_applications.size > 0 %}
            {% for discount in cart.cart_level_discount_applications %}
              <div class="summary-line discount">
                <span>Discount ({{ discount.title }}):</span>
                <span>-{{ discount.total_allocated_amount | money }}</span>
              </div>
            {% endfor %}
          {% endif %}

          <div class="summary-line total">
            <span>Total:</span>
            <span class="total-price">{{ cart.total_price | money }}</span>
          </div>

          <p class="tax-note">Taxes and shipping calculated at checkout</p>

          <button type="button" class="checkout-btn" onclick="validateAndCheckout()">
            Proceed to Checkout
          </button>

          <a href="/" class="continue-shopping">
            ‚Üê Continue Shopping
          </a>
        </div>
      </div>
    {% else %}
      <div class="empty-cart">
        <p class="empty-message">Your cart is empty</p>
        <a href="/#pricing" class="return-btn">View Pricing Plans</a>
      </div>
    {% endif %}
  </div>
</section>

<!-- Toast Notification -->
<div id="cart-toast" class="cart-toast"></div>

<style>
  /* Prerequisites Container Styles */
  .prerequisites-container {
    background: rgba(20, 20, 20, 0.6);
    border: 2px solid rgba(255, 107, 107, 0.3);
    border-radius: 12px;
    padding: 24px;
    margin: 24px 0;
  }

  .prerequisites-title {
    color: #ff6b6b;
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 20px 0;
    letter-spacing: 0.5px;
  }

  .prerequisite-item {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    transition: all 0.3s ease;
  }

  .prerequisite-item:hover {
    border-color: rgba(0, 255, 136, 0.3);
    transform: translateX(4px);
  }

  .prerequisite-item.disclaimer {
    border-color: rgba(255, 193, 7, 0.4);
    background: rgba(255, 193, 7, 0.05);
  }

  .prerequisite-item.action-required {
    border-color: rgba(255, 107, 107, 0.5);
    background: rgba(255, 107, 107, 0.08);
  }

  .prerequisite-number {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
    color: #000;
    font-size: 18px;
    font-weight: 700;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .prerequisite-label {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 6px 12px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .prerequisite-item.disclaimer .prerequisite-label {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
  }

  .prerequisite-content {
    flex: 1;
  }

  .prerequisite-content strong {
    color: #00ff88;
    font-size: 16px;
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
  }

  .prerequisite-item.disclaimer .prerequisite-content strong {
    color: #ffc107;
  }

  .prerequisite-item.action-required .prerequisite-content strong {
    color: #ff6b6b;
  }

  .prerequisite-content p {
    color: #b8b8b8;
    font-size: 14px;
    line-height: 1.6;
    margin: 0;
  }

  .prerequisite-content ul {
    list-style: disc;
    margin: 8px 0 0 0;
    padding-left: 20px;
  }

  .prerequisite-content ul li {
    color: #b8b8b8;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 4px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .prerequisites-container {
      padding: 16px;
    }

    .prerequisite-item {
      flex-direction: column;
      gap: 12px;
    }

    .prerequisite-number {
      width: 28px;
      height: 28px;
      font-size: 16px;
    }

    .prerequisites-title {
      font-size: 16px;
    }

    .prerequisite-content strong {
      font-size: 15px;
    }

    .prerequisite-content p,
    .prerequisite-content ul li {
      font-size: 13px;
    }
  }
</style>

<script src="{{ 'cart.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Cart",
  "settings": [
    {
      "type": "text",
      "id": "cart_title",
      "label": "Cart Title",
      "default": "Your Cart"
    },
    {
      "type": "text",
      "id": "empty_cart_message",
      "label": "Empty Cart Message",
      "default": "Your cart is currently empty."
    },
    {
      "type": "text",
      "id": "continue_shopping_text",
      "label": "Continue Shopping Button Text",
      "default": "Continue Shopping"
    }
  ]
}
{% endschema %}